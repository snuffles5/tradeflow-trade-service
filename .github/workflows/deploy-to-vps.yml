name: Deploy to VPS

on:
  workflow_dispatch:
    inputs:
      api_tag:
        description: 'API image tag to deploy'
        required: true
        default: 'main'
      web_tag:
        description: 'Web image tag to deploy'
        required: true
        default: 'main'

jobs:
  deploy:
    name: Deploy to Production VPS
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e
            cd /opt/tradeflow
            
            echo "Creating .env file from GitHub Secrets..."
            cat <<'EOF' > .env
            # This file is auto-generated by GitHub Actions
            API_IMAGE_TAG=${{ github.event.inputs.api_tag }}
            WEB_IMAGE_TAG=${{ github.event.inputs.web_tag }}
            
            API_PORT=${{ secrets.API_PORT }}
            WEB_PORT=${{ secrets.WEB_PORT }}
            
            DB_HOST=${{ secrets.DB_HOST }}
            DB_PORT=${{ secrets.DB_PORT }}
            DB_NAME=${{ secrets.DB_NAME }}
            DB_USER=${{ secrets.DB_USER }}
            DB_PASS=${{ secrets.DB_PASS }}
            
            SPRING_DATASOURCE_URL=jdbc:mysql://${{ secrets.DB_HOST }}:${{ secrets.DB_PORT }}/${{ secrets.DB_NAME }}?createDatabaseIfNotExist=true&sslMode=REQUIRED
            SPRING_DATASOURCE_USERNAME=${{ secrets.DB_USER }}
            SPRING_DATASOURCE_PASSWORD=${{ secrets.DB_PASS }}
            SPRING_JPA_HIBERNATE_DDL_AUTO=validate
            SPRING_FLYWAY_ENABLED=true
            
            YAHOO_APP_ID=${{ secrets.YAHOO_APP_ID }}
            YAHOO_CLIENT_ID=${{ secrets.YAHOO_CLIENT_ID }}
            YAHOO_CLIENT_SECRET=${{ secrets.YAHOO_CLIENT_SECRET }}
            YAHOO_REDIRECT_URI=${{ secrets.YAHOO_REDIRECT_URI }}
            
            PUBLIC_API_URL=${{ secrets.PUBLIC_API_URL }}
            EOF
            
            echo "Logging into GHCR..."
            echo ${{ secrets.GHCR_PAT }} | docker login ghcr.io -u ${{ github.repository_owner }} --password-stdin
            
            echo "Pulling new images..."
            docker compose -f docker-compose.yml pull
            
            echo "Deploying services..."
            docker compose -f docker-compose.yml up -d --force-recreate
            docker compose -f docker-compose.yml ps
            
            echo "Deployment complete."